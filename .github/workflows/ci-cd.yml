name: CI/CD

on:
  push:
    branches:
      - main

jobs:                           # <- This is required
  terraform:                    # <- Your job name goes here
    needs: setup_runner
    runs-on: self-hosted
    environment: production
    defaults:
      run:
        working-directory: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure GCP Credentials
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}
          workload_identity_provider: ${{ secrets.GCP_WI_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Verify or Create GCS Bucket
        run: |
          export BUCKET_NAME="tf-state-bucket-${{ secrets.GCP_PROJECT }}"
          if ! gsutil ls gs://$BUCKET_NAME >/dev/null 2>&1; then
            echo "Creating GCS bucket for Terraform state..."
            gsutil mb -p ${{ secrets.GCP_PROJECT }} -l ${{ env.GCP_REGION }} gs://$BUCKET_NAME
            gsutil versioning set on gs://$BUCKET_NAME
          else
            echo "Bucket already exists"
          fi

      - name: Terraform Init
        run: terraform init -input=false

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -out=tfplan -input=false

      - name: Terraform Apply
        run: terraform apply -input=false -auto-approve tfplan
